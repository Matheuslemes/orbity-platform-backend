services:
  redis:
    image: redis:7-alpine
    container_name: dev-redis
    command: ["redis-server", "--appendonly", "yes"]
    ports: ["6379:6379"]
    volumes: [redisdata:/data]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks: [devnet]

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: dev-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports: ["2181:2181"]
    healthcheck:
      # usa script oficial da Confluent
      test: ["CMD-SHELL", "cub zk-ready localhost 2181 10 5 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [devnet]

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: dev-kafka
    depends_on:
      zookeeper: { condition: service_healthy }
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"

      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092,PLAINTEXT_HOST://host.docker.internal:9094"
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:9094"
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      # dev-friendly
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_DELETE_TOPIC_ENABLE: "true"

      # memória (evita OOM)
      KAFKA_HEAP_OPTS: "-Xms512m -Xmx512m"
    ports:
      - "9094:9094"   # expõe apenas o listener externo
    volumes:
      - kafkadata:/var/lib/kafka/data
    healthcheck:
      # usa script oficial da Confluent para checar readiness do broker
      test: ["CMD-SHELL", "cub kafka-ready -b localhost:9092 1 30 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 15
    networks: [devnet]

  kafdrop:
    image: obsidiandynamics/kafdrop:latest
    container_name: dev-kafdrop
    restart: unless-stopped
    ports: ["9000:9000"]
    environment:
      KAFKA_BROKERCONNECT: "kafka:9092"
      JVM_OPTS: "-Xms32M -Xmx128M"
    depends_on:
      kafka: { condition: service_healthy }
    networks: [devnet]

  postgres:
    image: postgres:16-alpine
    container_name: dev-postgres
    environment:
      POSTGRES_USER: orbity
      POSTGRES_PASSWORD: orbity
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d postgres -h localhost"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [devnet]

  pgadmin:
    image: dpage/pgadmin4:8.10
    container_name: dev-pgadmin
    depends_on:
      postgres: { condition: service_healthy }
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@local
      PGADMIN_DEFAULT_PASSWORD: admin
    ports: ["5050:80"]
    networks: [devnet]

  mongo:
    image: mongo:7
    container_name: dev-mongo
    ports: ["27017:27017"]
    volumes: [mongodata:/data/db]
    networks: [devnet]

  opensearch:
    image: opensearchproject/opensearch:2.13.0
    container_name: dev-opensearch
    environment:
      discovery.type: single-node
      DISABLE_SECURITY_PLUGIN: "true"
      OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
    ulimits:
      memlock: { soft: -1, hard: -1 }
    ports: ["9200:9200", "9600:9600"]
    volumes: [osdata:/usr/share/opensearch/data]
    networks: [devnet]

  osdash:
    image: opensearchproject/opensearch-dashboards:2.13.0
    container_name: dev-opensearch-dashboards
    environment:
      OPENSEARCH_HOSTS: '["http://opensearch:9200"]'
      DISABLE_SECURITY_DASHBOARDS_PLUGIN: "true"
    ports: ["5601:5601"]
    depends_on:
      opensearch:
        condition: service_started
    networks: [devnet]

  minio:
    image: minio/minio:RELEASE.2024-09-22T00-33-43Z
    container_name: dev-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports: ["9000:9000","9001:9001"]
    volumes: [miniodata:/data]
    networks: [devnet]

  minio-mc:
    image: minio/mc:latest
    container_name: dev-minio-mc
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      for i in 1 2 3 4 5; do
        mc alias set local http://minio:9000 minioadmin minioadmin && break || sleep 2;
      done;
      (mc ls local/media || mc mb local/media);
      mc anonymous set download local/media || true;
      echo 'MinIO bucket media pronto';
      "
    networks: [devnet]

  keycloak:
    image: quay.io/keycloak/keycloak:25.0.6
    container_name: dev-keycloak
    command: start-dev --http-port=8085
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_PROXY: "edge"
    ports: ["8085:8085"]
    networks: [devnet]

networks:
  devnet: { driver: bridge }

volumes:
  redisdata:
  kafkadata:
  pgdata:
  mongodata:
  osdata:
  miniodata:
